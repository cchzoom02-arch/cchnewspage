<!doctype html>
<html lang="zh-Hant">
 <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æ–°èç™¼å¸ƒæ¥­å‹™é€²åº¦</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;800&amp;display=swap" rel="stylesheet">
  <style>
  body {
    box-sizing: border-box;
  }
  :root{
    --ink:#111111;
    --muted:#6B7280;
    --line:#E6E6E6;
    --accent:#D80000;
    --soft-red:#FFFAFA;
    --soft-red-line:#FFDDDD;
    --blue:#2563EB;
    --green:#059669;
    --purple:#7C3AED;
    --soft-purple:#F8F5FF;
    --soft-purple-line:#E0D4FF;
  }
  *{box-sizing:border-box}
  body{
    font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    color:var(--ink); background:#fff; margin:0; line-height:1.5;
  }
  .wrap{max-width:1200px;margin:40px auto;padding:0 24px}
  h1{font-weight:800;font-size:52px;letter-spacing:.5px;text-align:center;margin:0 0 28px}
  
  /* åŸå§‹å¡ç‰‡æ¨£å¼ */
  .card{
    display:grid; grid-template-columns:140px 1fr 240px; gap:24px;
    border:2px solid var(--line); border-radius:16px; padding:16px 20px; margin:0 0 20px;
    background:#fff; position:relative;
  }
  .card.accent{border-color:var(--soft-red-line); background:var(--soft-red)}
  .card.purple{border-color:var(--soft-purple-line); background:var(--soft-purple)}
  .date{
    padding-right:20px; border-right:2px solid var(--line);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    text-align:center;
  }
  .date .label,.date .weekday{font-size:14px;color:var(--muted);letter-spacing:1px}
  .date .day{font-size:56px;font-weight:800;line-height:1}
  .card.accent .date .label,
  .card.accent .date .day,
  .card.accent .date .weekday{color:var(--accent)}
  .card.purple .date .label,
  .card.purple .date .day,
  .card.purple .date .weekday{color:var(--purple)}
  .content{display:flex; align-items:center}
  .content h2{margin:0; font-size:40px; line-height:1.15; font-weight:800}
  .content h2.red{color:var(--accent)}
  .content h2.purple{color:var(--purple)}
  .meta{
    padding-left:20px; border-left:2px solid var(--line);
    background:#F7F7F7; border-radius:12px; padding:12px 16px; display:flex; flex-direction:column; justify-content:center
  }
  .meta .row{margin:4px 0; font-size:16px}
  .meta .key{color:var(--muted); margin-right:6px}

  /* ç®¡ç†åŠŸèƒ½æ¨£å¼ */
  .admin-btn{
    position:fixed; top:20px; right:20px; 
    background:var(--blue); color:white; border:none; padding:12px 20px; 
    border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;
    box-shadow:0 4px 12px rgba(37,99,235,0.3); z-index:100;
  }
  .admin-btn:hover{background:#1d4ed8}

  .edit-btn{
    position:absolute; top:16px; right:16px;
    background:var(--green); color:white; border:none; padding:8px 12px;
    border-radius:6px; cursor:pointer; font-size:12px; opacity:0; transition:opacity 0.3s;
    display:none;
  }
  .admin-mode .edit-btn{opacity:1; display:block}
  .edit-btn:hover{background:#047857}

  .add-btn{
    background:var(--blue); color:white; border:none; padding:16px 32px;
    border-radius:12px; cursor:pointer; font-size:16px; font-weight:600;
    margin:20px auto; display:none; box-shadow:0 4px 12px rgba(37,99,235,0.3);
  }
  .admin-mode .add-btn{display:block}
  .add-btn:hover{background:#1d4ed8}

  /* æ¨¡æ…‹æ¡†æ¨£å¼ */
  .modal{
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;
  }
  .modal.show{display:flex}
  .modal-content{
    background:white; padding:32px; border-radius:16px; width:500px; max-width:90%;
    box-shadow:0 20px 60px rgba(0,0,0,0.3); max-height:90vh; overflow-y:auto;
  }
  .modal h3{margin:0 0 24px; font-size:24px; text-align:center; font-weight:800}
  
  .form-group{margin:20px 0}
  .form-group label{display:block; margin-bottom:8px; font-weight:600; color:var(--ink)}
  .form-group input, .form-group select, .form-group textarea{
    width:100%; padding:12px 16px; border:2px solid var(--line); border-radius:8px;
    font-size:16px; font-family:inherit; transition:border-color 0.3s;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus{
    outline:none; border-color:var(--blue);
  }
  .form-group textarea{resize:vertical; min-height:100px}
  
  .btn{
    background:var(--blue); color:white; border:none; padding:12px 24px;
    border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; margin:8px 4px;
    transition:background-color 0.3s;
  }
  .btn:hover{background:#1d4ed8}
  .btn.secondary{background:var(--muted)}
  .btn.secondary:hover{background:#4b5563}
  .btn.danger{background:var(--accent)}
  .btn.danger:hover{background:#b91c1c}

  /* äººå“¡ç®¡ç†æ¨£å¼ */
  .staff-section{
    margin:24px 0; padding:20px; background:#f8f9fa; border-radius:12px;
  }
  .staff-section h4{margin:0 0 16px; font-size:18px; font-weight:600}
  .staff-list{
    display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px; margin:16px 0;
  }
  .staff-item{
    background:white; padding:12px 16px; border-radius:8px; border:1px solid var(--line);
    display:flex; justify-content:space-between; align-items:center;
  }
  .remove-staff{
    background:var(--accent); color:white; border:none; padding:6px 12px;
    border-radius:4px; cursor:pointer; font-size:12px;
  }
  .remove-staff:hover{background:#b91c1c}

  /* æª”æ¡ˆä¸Šå‚³æ¨£å¼ */
  .file-upload{
    border:2px dashed var(--line); border-radius:8px; padding:30px;
    text-align:center; cursor:pointer; transition:all 0.3s;
    background:#fafafa;
  }
  .file-upload:hover{border-color:var(--blue); background:#f0f8ff}
  .file-upload input{display:none}
  .file-upload p{margin:0; color:var(--muted)}
  .file-upload small{color:var(--muted); font-size:12px}

  .checkbox-group{
    display:flex; align-items:center; gap:8px; margin:16px 0;
  }
  .checkbox-group input[type="checkbox"]{
    width:auto; margin:0;
  }

  @media (max-width:900px){
    .card{grid-template-columns:1fr; }
    .date{border-right:0; border-bottom:2px solid var(--line); padding-bottom:12px; margin-bottom:8px}
    .meta{border-left:0; margin-top:8px}
    .content h2{font-size:28px}
    .date .day{font-size:42px}
    .modal-content{width:95%; padding:20px}
    .admin-btn{position:static; margin:20px auto; display:block; width:fit-content}
  }
</style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><button class="admin-btn" onclick="showLoginModal()">ç®¡ç†å¾Œå°</button>
  <div class="wrap">
   <h1>æ–°èç™¼å¸ƒæ¥­å‹™é€²åº¦</h1>
   <div style="text-align:center; margin:20px 0"><button class="add-btn" onclick="addNews()">+ æ–°å¢æ–°è</button> <button class="add-btn" onclick="showHistoryModal()" style="background:var(--muted); margin-left:12px">ğŸ“š æ­·å²ç´€éŒ„</button>
   </div>
   <div id="newsContainer"></div>
  </div><div id="loginModal" class="modal">
   <div class="modal-content">
    <h3>ğŸ” ç®¡ç†å“¡ç™»å…¥</h3>
    <div class="form-group"><label>è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š</label> <input type="password" id="adminPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onkeypress="if(event.key==='Enter') login()">
    </div>
    <div style="text-align:center"><button class="btn" onclick="login()">ç™»å…¥</button> <button class="btn secondary" onclick="closeModal('loginModal')">å–æ¶ˆ</button>
    </div>
   </div>
  </div><div id="editModal" class="modal">
   <div class="modal-content">
    <h3 id="editTitle">ç·¨è¼¯æ–°è</h3>
    <div class="form-group"><label>ğŸ“… ç™¼å¸ƒæ—¥æœŸï¼š</label> <input type="date" id="editDate" required>
    </div>
    <div class="form-group"><label>ğŸ“° æ–°èæ¨™é¡Œï¼š</label> <textarea id="editNewsTitle" placeholder="è«‹è¼¸å…¥æ–°èæ¨™é¡Œ" required></textarea>
    </div>
    <div class="form-group"><label>âœï¸ ç·¨è¼¯äººå“¡ï¼š</label> <select id="editEditor" required> <option value="">è«‹é¸æ“‡ç·¨è¼¯äººå“¡</option> </select>
    </div>
    <div class="form-group"><label>ğŸ¬ å½±ç‰‡äººå“¡ï¼š</label> <select id="editVideo" required> <option value="">è«‹é¸æ“‡å½±ç‰‡äººå“¡</option> </select>
    </div>
    <div class="form-group"><label>ğŸ¨ å¹³é¢äººå“¡ï¼š</label> <select id="editGraphic" required> <option value="">è«‹é¸æ“‡å¹³é¢äººå“¡</option> </select>
    </div>
    <div class="checkbox-group"><input type="checkbox" id="editAccent"> <label for="editAccent">â­ é‡é»æ–°èï¼ˆç´«è‰²æ¨™ç¤ºï¼‰</label>
    </div>
    <div style="text-align:center; margin-top:32px"><button class="btn" onclick="saveNews()">ğŸ’¾ å„²å­˜</button> <button class="btn danger" onclick="deleteNews()" id="deleteBtn">âœ… å®Œæˆæ–°è</button> <button class="btn secondary" onclick="closeModal('editModal')">å–æ¶ˆ</button>
    </div>
   </div>
  </div><div id="historyModal" class="modal">
   <div class="modal-content" style="width:900px; max-width:95%; max-height:90vh">
    <h3>ğŸ“š æ–°èæ­·å²ç´€éŒ„</h3><div class="staff-section">
     <h4>ğŸ” æœå°‹æ¢ä»¶</h4>
     <div style="display:grid; grid-template-columns:1fr 1fr 2fr auto; gap:12px; margin-bottom:16px"><select id="searchYear"> <option value="">é¸æ“‡å¹´ä»½</option> </select> <select id="searchMonth"> <option value="">é¸æ“‡æœˆä»½</option> <option value="1">1æœˆ</option> <option value="2">2æœˆ</option> <option value="3">3æœˆ</option> <option value="4">4æœˆ</option> <option value="5">5æœˆ</option> <option value="6">6æœˆ</option> <option value="7">7æœˆ</option> <option value="8">8æœˆ</option> <option value="9">9æœˆ</option> <option value="10">10æœˆ</option> <option value="11">11æœˆ</option> <option value="12">12æœˆ</option> </select> <input type="text" id="searchKeyword" placeholder="è¼¸å…¥é—œéµå­—æœå°‹æ¨™é¡Œå…§å®¹..."> <button class="btn" onclick="searchHistory()">æœå°‹</button>
     </div>
     <div style="text-align:center"><button class="btn secondary" onclick="clearSearch()" style="font-size:14px; padding:8px 16px">æ¸…é™¤æ¢ä»¶</button> <span id="searchResults" style="margin-left:16px; color:var(--muted); font-size:14px"></span>
     </div>
    </div><div class="staff-section">
     <h4>ğŸ“° æ­·å²æ–°è (<span id="historyCount">0</span>)</h4>
     <div id="historyList" style="max-height:400px; overflow-y:auto; border:1px solid var(--line); border-radius:8px; padding:16px; background:white"></div>
    </div>
    <div style="text-align:center; margin-top:32px"><button class="btn" onclick="downloadHistoryExcel()" style="background:var(--green); margin-right:12px">ğŸ“¥ ä¸‹è¼‰Excel</button> <button class="btn secondary" onclick="closeModal('historyModal')">é—œé–‰</button>
    </div>
   </div>
  </div><div id="staffModal" class="modal">
   <div class="modal-content" style="width:800px; max-width:95%">
    <h3>ğŸ‘¥ ç®¡ç†å¾Œå°</h3><div class="staff-section">
     <h4>ğŸ“° æ–°èç®¡ç†</h4>
     <div style="text-align:center; margin:16px 0"><button class="btn" onclick="addNews()">â• æ–°å¢æ–°è</button>
     </div>
     <div id="adminNewsList" style="max-height:300px; overflow-y:auto; border:1px solid var(--line); border-radius:8px; padding:16px; background:white"></div>
    </div>
    <div class="staff-section">
     <h4>ğŸ“Š Excelæª”æ¡ˆåŒ¯å…¥</h4>
     <div class="file-upload" onclick="document.getElementById('excelFile').click()"><input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="importExcel(event)">
      <p>ğŸ“ é»æ“Šä¸Šå‚³Excelæª”æ¡ˆ</p><small>æ”¯æ´æ ¼å¼ï¼š.xlsx, .xls, .csv<br>
       æ¬„ä½ï¼šå“¡å·¥ç·¨è™Ÿã€å§“åã€è·ä½ï¼ˆç·¨è¼¯/å½±ç‰‡/å¹³é¢ï¼‰</small>
     </div>
    </div>
    <div class="staff-section">
     <h4>â• æ‰‹å‹•æ–°å¢äººå“¡</h4>
     <div style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:12px; margin-bottom:16px"><input type="text" id="staffId" placeholder="å“¡å·¥ç·¨è™Ÿ"> <input type="text" id="staffName" placeholder="å§“å"> <select id="staffRole"> <option value="editor">ç·¨è¼¯</option> <option value="video">å½±ç‰‡</option> <option value="graphic">å¹³é¢</option> </select> <button class="btn" onclick="addStaff()">æ–°å¢</button>
     </div>
    </div>
    <div class="staff-section">
     <h4>âœï¸ ç·¨è¼¯äººå“¡ (<span id="editorCount">0</span>)</h4>
     <div id="editorList" class="staff-list"></div>
    </div>
    <div class="staff-section">
     <h4>ğŸ¬ å½±ç‰‡äººå“¡ (<span id="videoCount">0</span>)</h4>
     <div id="videoList" class="staff-list"></div>
    </div>
    <div class="staff-section">
     <h4>ğŸ¨ å¹³é¢äººå“¡ (<span id="graphicCount">0</span>)</h4>
     <div id="graphicList" class="staff-list"></div>
    </div>
    <div style="text-align:center; margin-top:32px"><button class="btn" onclick="closeModal('staffModal')">âœ… å®Œæˆ</button>
    </div>
   </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
// ã€é‡è¦ã€‘å°‡é€™è£¡æ›¿æ›æˆæ‚¨åœ¨æ­¥é©ŸäºŒéƒ¨ç½²å¾Œè¤‡è£½çš„ Web æ‡‰ç”¨ç¨‹å¼ URL
// ç¯„ä¾‹ï¼šconst SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz/exec";
const SCRIPT_URL = "ã€è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Apps Script Web App URLã€‘"; 

// åˆå§‹è®Šæ•¸ (ç¾åœ¨ç”± Apps Script è¼‰å…¥è³‡æ–™)
let newsData = []; 
let staffData = {editor: [], video: [], graphic: []};
let isAdminMode = false;
let editingId = null;
let autoDeleteTimer = null;
let historyData = []; 
let filteredHistory = []; 

// ------------------------------------------------------------------
// æ–°å¢ï¼šå¾Œç«¯ API ç›¸é—œå‡½æ•¸
// ------------------------------------------------------------------

// çµ±ä¸€çš„ API è®€å–å‡½æ•¸
async function loadData() {
  try {
    showNotification('ğŸ”„ æ­£åœ¨å¾ Google Sheets è¼‰å…¥è³‡æ–™...', 'info');
    const response = await fetch(SCRIPT_URL, {
      method: 'GET',
      redirect: 'follow', // è™•ç† Apps Script çš„é‡æ–°å°å‘
    });
    
    if (!response.ok) {
        throw new Error(`ç¶²è·¯éŒ¯èª¤: ${response.status} ${response.statusText}`);
    }
    
    const data = await response.json();

    if (data.error) {
        throw new Error(`Apps Script éŒ¯èª¤: ${data.error}`);
    }

    newsData = data.newsData || [];
    staffData = data.staffData || {editor: [], video: [], graphic: []};
    historyData = data.historyData || [];
    
    // é¦–æ¬¡è¼‰å…¥å®Œæˆå¾Œï¼ŒåŸ·è¡Œä¸€æ¬¡æ¸²æŸ“å’Œåˆªé™¤æª¢æŸ¥
    renderNews();
    updateStaffSelects(); // ç¢ºä¿äººå“¡é¸å–®åœ¨è¼‰å…¥å¾Œç«‹å³æ›´æ–°
    
    showNotification('âœ… è³‡æ–™è¼‰å…¥æˆåŠŸï¼', 'success');

  } catch (error) {
    console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
    showNotification(`âŒ è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š${error.message}ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²èˆ‡é€£ç·šç‹€æ…‹ã€‚`, 'error');
  }
}

// çµ±ä¸€çš„ API å¯«å…¥å‡½æ•¸
async function saveData(action) {
  // **å¾Œç«¯å¯†ç¢¼é©—è­‰**ï¼šå¯†ç¢¼åœ¨å‰ç«¯ï¼Œå¿…é ˆé€é POST å‚³çµ¦å¾Œç«¯é©—è­‰ã€‚
  const password = 'cch4156'; 
  
  // ç¢ºå®šè¦å‚³é€çš„è³‡æ–™çµæ§‹
  let dataToSend = {};
  if (action === 'saveNews' || action === 'restoreNews') {
      dataToSend = { newsData, historyData };
  } else if (action === 'deleteHistory') {
      dataToSend = { historyData };
  } else if (action === 'saveStaff') {
      dataToSend = { staffData };
  }
  
  try {
    showNotification(`ğŸ”„ æ­£åœ¨å„²å­˜è³‡æ–™ (${action})...`, 'info');
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      redirect: 'follow',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: action, // å‘Šè¨´ Apps Script è¦åŸ·è¡Œä»€éº¼å‹•ä½œ
        password: password,
        data: dataToSend
      }),
    });
    
    if (!response.ok) {
        throw new Error(`ç¶²è·¯éŒ¯èª¤: ${response.status} ${response.statusText}`);
    }
    
    const result = await response.json();

    if (result.status === "error") {
      throw new Error(result.message);
    }
    
    showNotification('âœ… è³‡æ–™å·²æˆåŠŸå„²å­˜åˆ° Google Sheetsï¼', 'success');
    return true;

  } catch (error) {
    console.error('å„²å­˜è³‡æ–™å¤±æ•—:', error);
    showNotification(`âŒ è³‡æ–™å„²å­˜å¤±æ•—ï¼š${error.message}`, 'error');
    return false;
  }
}


// è‡ªå‹•åˆªé™¤éæœŸæ–°èå‡½æ•¸
async function autoDeleteExpiredNews() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const originalNewsData = [...newsData]; // å‚™ä»½åŸå§‹è³‡æ–™
  const originalHistoryData = [...historyData];

  const originalNewsLength = newsData.length;
  
  // æª¢æŸ¥æ˜¯å¦æœ‰éæœŸæ–°è
  const expiredNews = newsData.filter(news => {
    const newsDate = new Date(news.date);
    newsDate.setHours(0, 0, 0, 0);
    return newsDate < today;
  });
  
  if (expiredNews.length > 0) {
      // è™•ç†å‰ç«¯è³‡æ–™
      expiredNews.forEach(news => {
        const exists = historyData.some(h => h.id === news.id && h.date === news.date);
        if (!exists) {
          historyData.push({
            ...news,
            archivedDate: new Date().toISOString().split('T')[0]
          });
        }
      });
      
      // ä¿ç•™ä»Šå¤©åŠä»¥å¾Œçš„æ–°è
      newsData = newsData.filter(news => {
        const newsDate = new Date(news.date);
        newsDate.setHours(0, 0, 0, 0);
        return newsDate >= today;
      });
      
      // å¦‚æœæœ‰æ–°èè¢«è‡ªå‹•åˆªé™¤ï¼Œå‘¼å« saveData
      if (newsData.length < originalNewsLength) {
        const success = await saveData('saveNews');
        if (success) {
            console.log(`è‡ªå‹•åˆªé™¤äº† ${originalNewsLength - newsData.length} å‰‡éæœŸæ–°èï¼Œå·²åŠ å…¥æ­·å²ç´€éŒ„`);
        } else {
             // å¦‚æœå¾Œç«¯å„²å­˜å¤±æ•—ï¼Œå¾©åŸå‰ç«¯è³‡æ–™
             newsData = originalNewsData;
             historyData = originalHistoryData;
             console.error('è‡ªå‹•åˆªé™¤æ“ä½œå¤±æ•—ï¼Œè³‡æ–™æœªå„²å­˜åˆ°å¾Œç«¯ã€‚å·²å¾©åŸå‰ç«¯è³‡æ–™ã€‚');
        }
      }
  }
}

// è¨­å®šè‡ªå‹•åˆªé™¤å®šæ™‚å™¨
function scheduleAutoDelete() {
  // æ¸…é™¤ç¾æœ‰å®šæ™‚å™¨
  if (autoDeleteTimer) {
    clearTimeout(autoDeleteTimer);
  }
  
  const now = new Date();
  const tomorrow = new Date(now);
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(0, 0, 0, 0); // è¨­å®šç‚ºéš”æ—¥00:00
  
  const timeUntilMidnight = tomorrow.getTime() - now.getTime();
  
  // è¨­å®šå®šæ™‚å™¨åœ¨éš”æ—¥00:00åŸ·è¡Œ
  autoDeleteTimer = setTimeout(async () => {
    await autoDeleteExpiredNews();
    renderNews(); // é‡æ–°æ¸²æŸ“é é¢
    updateAdminNewsList(); // æ›´æ–°ç®¡ç†å¾Œå°åˆ—è¡¨
    
    // è¨­å®šä¸‹ä¸€æ¬¡è‡ªå‹•åˆªé™¤ï¼ˆæ¯24å°æ™‚åŸ·è¡Œä¸€æ¬¡ï¼‰
    setInterval(async () => {
      await autoDeleteExpiredNews();
      renderNews();
      updateAdminNewsList();
    }, 24 * 60 * 60 * 1000); // 24å°æ™‚
    
  }, timeUntilMidnight);
  
  console.log(`å·²è¨­å®šè‡ªå‹•åˆªé™¤å®šæ™‚å™¨ï¼Œå°‡æ–¼ ${tomorrow.toLocaleString()} åŸ·è¡Œ`);
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  loadData(); // è¼‰å…¥è³‡æ–™ (åŒ…å«åˆå§‹ renderNews)
});

// æ¸²æŸ“æ–°èåˆ—è¡¨
function renderNews() {
  const container = document.getElementById('newsContainer');
  container.innerHTML = '';
  
  // ç”±æ–¼ loadData() å·²ç¶“å‘¼å« autoDeleteExpiredNews()ï¼Œé€™è£¡åªéœ€è¨­å®šå®šæ™‚å™¨
  scheduleAutoDelete();
  
  // æ’åºï¼šä»Šå¤©çš„æ–°èåœ¨æœ€ä¸Šæ–¹ï¼Œå…¶é¤˜æŒ‰æ—¥æœŸæ’åº
  const today = new Date();
  const sortedNews = [...newsData].sort((a, b) => {
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©
    const isToday = (date) => {
      const checkDate = new Date(date);
      return checkDate.toDateString() === today.toDateString();
    };
    
    const aIsToday = isToday(dateA);
    const bIsToday = isToday(dateB);
    
    // ä»Šå¤©çš„æ–°èå„ªå…ˆ
    if (aIsToday && !bIsToday) return -1;
    if (!aIsToday && bIsToday) return 1;
    
    // å…¶é¤˜æŒ‰æ—¥æœŸæ’åº
    return dateA - dateB;
  });
  
  sortedNews.forEach(news => {
    const newsDate = new Date(news.date);
    const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    const dayOfWeek = dayNames[newsDate.getDay()];
    const dateStr = `${newsDate.getMonth() + 1}/${newsDate.getDate()}`;
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©çš„æ–°è
    const isToday = newsDate.toDateString() === today.toDateString();
    
    const editor = staffData.editor.find(s => s.id === news.editor);
    const video = staffData.video.find(s => s.id === news.video);
    const graphic = staffData.graphic.find(s => s.id === news.graphic);
    
    const card = document.createElement('section');
    // ä»Šå¤©çš„æ–°èè‡ªå‹•è®Šæˆç´…è‰²é‡é»æ–°èï¼Œæ‰‹å‹•è¨­å®šçš„é‡é»æ–°èç‚ºç´«è‰²
    let cardClass = 'card';
    let titleClass = '';
    
    if (isToday) {
      cardClass += ' accent';
      titleClass = 'red';
    } else if (news.accent) {
      cardClass += ' purple';
      titleClass = 'purple';
    }
    
    card.className = cardClass;
    card.innerHTML = `
      <button class="edit-btn" onclick="editNews(${news.id})">ç·¨è¼¯</button>
      <div class="date">
        <div class="label">é è¨ˆç™¼å¸ƒ</div>
        <div class="day">${dateStr}</div>
        <div class="weekday">ç¦®æ‹œ${dayOfWeek}</div>
      </div>
      <div class="content">
        <h2 ${titleClass ? `class="${titleClass}"` : ''}>${news.title}</h2>
      </div>
      <aside class="meta">
        <div class="row"><span class="key">ç·¨è¼¯ï¼š</span>${news.editor}ï¼ˆ${editor ? editor.name : 'æœªæŒ‡æ´¾'}ï¼‰</div>
        <div class="row"><span class="key">å½±ç‰‡ï¼š</span>${news.video}ï¼ˆ${video ? video.name : 'æœªæŒ‡æ´¾'}ï¼‰</div>
        <div class="row"><span class="key">å¹³é¢ï¼š</span>${news.graphic}ï¼ˆ${graphic ? graphic.name : 'æœªæŒ‡æ´¾'}ï¼‰</div>
      </aside>
    `;
    container.appendChild(card);
  });
}

// ç™»å…¥åŠŸèƒ½
function showLoginModal() {
  if (isAdminMode) {
    showStaffModal();
  } else {
    document.getElementById('loginModal').classList.add('show');
    document.getElementById('adminPassword').focus();
  }
}

function login() {
  const password = document.getElementById('adminPassword').value;
  if (password === 'cch4156') {
    isAdminMode = true;
    document.body.classList.add('admin-mode');
    document.querySelector('.admin-btn').textContent = 'ğŸ‘¥ äººå“¡ç®¡ç†';
    closeModal('loginModal');
    document.getElementById('adminPassword').value = '';
    
    // å‰µå»ºè‡ªå®šç¾©é€šçŸ¥
    showNotification('âœ… ç™»å…¥æˆåŠŸï¼ç¾åœ¨å¯ä»¥ç·¨è¼¯æ–°èå…§å®¹äº†ã€‚', 'success');
  } else {
    showNotification('âŒ å¯†ç¢¼éŒ¯èª¤ï¼è«‹é‡æ–°è¼¸å…¥ã€‚', 'error');
    document.getElementById('adminPassword').value = '';
    document.getElementById('adminPassword').focus();
  }
}

// æ–°èç·¨è¼¯åŠŸèƒ½
function editNews(id) {
  if (!isAdminMode) return;
  
  const news = newsData.find(n => n.id === id);
  if (!news) return;
  
  editingId = id;
  document.getElementById('editTitle').textContent = 'ğŸ“ ç·¨è¼¯æ–°è';
  document.getElementById('editDate').value = news.date;
  document.getElementById('editNewsTitle').value = news.title;
  document.getElementById('editAccent').checked = news.accent;
  document.getElementById('deleteBtn').style.display = 'inline-block';
  
  updateStaffSelects();
  document.getElementById('editEditor').value = news.editor;
  document.getElementById('editVideo').value = news.video;
  document.getElementById('editGraphic').value = news.graphic;
  
  document.getElementById('editModal').classList.add('show');
}

function addNews() {
  editingId = null;
  document.getElementById('editTitle').textContent = 'â• æ–°å¢æ–°è';
  document.getElementById('editDate').value = '';
  document.getElementById('editNewsTitle').value = '';
  document.getElementById('editAccent').checked = false;
  document.getElementById('deleteBtn').style.display = 'none';
  
  updateStaffSelects();
  document.getElementById('editEditor').value = '';
  document.getElementById('editVideo').value = '';
  document.getElementById('editGraphic').value = '';
  
  document.getElementById('editModal').classList.add('show');
}

async function saveNews() {
  const date = document.getElementById('editDate').value;
  const title = document.getElementById('editNewsTitle').value.trim();
  const editor = document.getElementById('editEditor').value;
  const video = document.getElementById('editVideo').value;
  const graphic = document.getElementById('editGraphic').value;
  const accent = document.getElementById('editAccent').checked;
  
  if (!date || !title || !editor || !video || !graphic) {
    showNotification('âš ï¸ è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼', 'warning');
    return;
  }
  
  const originalNewsData = [...newsData]; // å‚™ä»½åŸå§‹è³‡æ–™

  if (editingId) {
    // ç·¨è¼¯ç¾æœ‰æ–°è
    const index = newsData.findIndex(n => n.id === editingId);
    newsData[index] = {
      id: editingId,
      date, title, editor, video, graphic, accent
    };
  } else {
    // æ–°å¢æ–°è
    const newId = newsData.length > 0 ? Math.max(...newsData.map(n => parseInt(n.id))) + 1 : 1;
    newsData.push({
      id: String(newId), // ç¢ºä¿ id ç‚ºå­—ä¸²ä»¥åŒ¹é… Apps Script é‚è¼¯
      date, title, editor, video, graphic, accent
    });
  }
  
  const success = await saveData('saveNews');
  
  if (success) {
      renderNews();
      updateAdminNewsList();
      closeModal('editModal');
  } else {
      // å„²å­˜å¤±æ•—ï¼Œå¾©åŸå‰ç«¯è³‡æ–™
      newsData = originalNewsData;
  }
}

function deleteNews() {
  if (!editingId) {
    showNotification('âŒ ç„¡æ³•åˆªé™¤ï¼šæ‰¾ä¸åˆ°è¦åˆªé™¤çš„æ–°èï¼', 'error');
    return;
  }
  
  // å‰µå»ºè‡ªå®šç¾©ç¢ºèªå°è©±æ¡†
  showConfirmDialog('âš ï¸ ç¢ºå®šè¦å®Œæˆé€™å‰‡æ–°èå—ï¼Ÿå®Œæˆå¾Œæœƒç§»è‡³æ­·å²ç´€éŒ„ã€‚', async () => {
    const newsToDelete = newsData.find(n => n.id === editingId);
    if (newsToDelete) {
      const originalNewsData = [...newsData]; // å‚™ä»½åŸå§‹è³‡æ–™
      const originalHistoryData = [...historyData];

      // åŠ å…¥æ­·å²ç´€éŒ„ï¼ˆé¿å…é‡è¤‡ï¼‰
      const exists = historyData.some(h => h.id === newsToDelete.id && h.date === newsToDelete.date);
      if (!exists) {
        historyData.push({
          ...newsToDelete,
          archivedDate: new Date().toISOString().split('T')[0] // è¨˜éŒ„æ­¸æª”æ—¥æœŸ
        });
      }
      
      // å¾ç•¶å‰æ–°èä¸­ç§»é™¤
      newsData = newsData.filter(n => n.id !== editingId);
      
      const success = await saveData('saveNews');
      
      if (success) {
          renderNews();
          updateAdminNewsList(); // æ›´æ–°ç®¡ç†å¾Œå°åˆ—è¡¨
          closeModal('editModal');
      } else {
          // å„²å­˜å¤±æ•—ï¼Œå¾©åŸå‰ç«¯è³‡æ–™
          newsData = originalNewsData;
          historyData = originalHistoryData;
          showNotification('âŒ å®Œæˆå¤±æ•—ï¼šè³‡æ–™æœªå„²å­˜åˆ°å¾Œç«¯ï¼', 'error');
      }
      
    } else {
      showNotification('âŒ åˆªé™¤å¤±æ•—ï¼šæ‰¾ä¸åˆ°æŒ‡å®šçš„æ–°èï¼', 'error');
    }
  });
}

// äººå“¡ç®¡ç†åŠŸèƒ½
function showStaffModal() {
  updateStaffLists();
  updateAdminNewsList();
  document.getElementById('staffModal').classList.add('show');
}

// æ›´æ–°ç®¡ç†å¾Œå°çš„æ–°èåˆ—è¡¨
function updateAdminNewsList() {
  const container = document.getElementById('adminNewsList');
  container.innerHTML = '';
  
  if (newsData.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:var(--muted); margin:20px 0">ç›®å‰æ²’æœ‰æ–°èè³‡æ–™</p>';
    return;
  }
  
  // æŒ‰æ—¥æœŸæ’åºé¡¯ç¤º
  const sortedNews = [...newsData].sort((a, b) => new Date(a.date) - new Date(b.date));
  
  sortedNews.forEach(news => {
    const newsDate = new Date(news.date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const isToday = newsDate.toDateString() === today.toDateString();
    
    const editor = staffData.editor.find(s => s.id === news.editor);
    const video = staffData.video.find(s => s.id === news.video);
    const graphic = staffData.graphic.find(s => s.id === news.graphic);
    
    const newsItem = document.createElement('div');
    
    // æ±ºå®šæ¨£å¼ï¼šä»Šå¤©çš„æ–°èç‚ºç´…è‰²ï¼Œæ‰‹å‹•é‡é»æ–°èç‚ºç´«è‰²
    let bgColor = '#fff';
    let borderColor = 'var(--line)';
    let titleColor = 'var(--ink)';
    let starIcon = '';
    
    if (isToday) {
      bgColor = 'var(--soft-red)';
      borderColor = 'var(--soft-red-line)';
      titleColor = 'var(--accent)';
      starIcon = 'ğŸ”´';
    } else if (news.accent) {
      bgColor = 'var(--soft-purple)';
      borderColor = 'var(--soft-purple-line)';
      titleColor = 'var(--purple)';
      starIcon = 'ğŸŸ£';
    }
    
    newsItem.style.cssText = `
      border: 1px solid ${borderColor}; border-radius: 8px; padding: 12px; margin: 8px 0;
      background: ${bgColor};
    `;
    
    newsItem.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px">
        <div style="flex: 1">
          <div style="font-size: 14px; color: var(--muted); margin-bottom: 4px">
            ğŸ“… ${news.date} ${starIcon}
          </div>
          <div style="font-weight: 600; margin-bottom: 8px; color: ${titleColor}">
            ${news.title}
          </div>
          <div style="font-size: 12px; color: var(--muted)">
            ç·¨è¼¯ï¼š${editor ? editor.name : 'æœªæŒ‡æ´¾'} | 
            å½±ç‰‡ï¼š${video ? video.name : 'æœªæŒ‡æ´¾'} | 
            å¹³é¢ï¼š${graphic ? graphic.name : 'æœªæŒ‡æ´¾'}
          </div>
        </div>
        <button onclick="editNews(${news.id})" style="
          background: var(--green); color: white; border: none; padding: 6px 12px;
          border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;
        ">ç·¨è¼¯</button>
      </div>
    `;
    
    container.appendChild(newsItem);
  });
}

function updateStaffSelects() {
  const selects = ['editEditor', 'editVideo', 'editGraphic'];
  const roles = ['editor', 'video', 'graphic'];
  
  selects.forEach((selectId, index) => {
    const select = document.getElementById(selectId);
    const currentValue = select.value;
    select.innerHTML = `<option value="">è«‹é¸æ“‡${roles[index] === 'editor' ? 'ç·¨è¼¯' : roles[index] === 'video' ? 'å½±ç‰‡' : 'å¹³é¢'}äººå“¡</option>`;
    
    // æ’åº staffData by name (å¯é¸)
    const sortedStaff = [...staffData[roles[index]]].sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
    
    sortedStaff.forEach(staff => {
      const option = document.createElement('option');
      option.value = staff.id;
      option.textContent = `${staff.id}ï¼ˆ${staff.name}ï¼‰`;
      select.appendChild(option);
    });
    
    select.value = currentValue;
  });
}

function updateStaffLists() {
  const roles = ['editor', 'video', 'graphic'];
  
  roles.forEach(role => {
    const container = document.getElementById(`${role}List`);
    const count = document.getElementById(`${role}Count`);
    
    container.innerHTML = '';
    count.textContent = staffData[role].length;
    
    // æ’åº staffData by name (å¯é¸)
    const sortedStaff = [...staffData[role]].sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));

    sortedStaff.forEach(staff => {
      const item = document.createElement('div');
      item.className = 'staff-item';
      item.innerHTML = `
        <span><strong>${staff.id}</strong>ï¼ˆ${staff.name}ï¼‰</span>
        <button class="remove-staff" onclick="removeStaff('${role}', '${staff.id}')">ç§»é™¤</button>
      `;
      container.appendChild(item);
    });
  });
}

async function addStaff() {
  const id = document.getElementById('staffId').value.trim();
  const name = document.getElementById('staffName').value.trim();
  const role = document.getElementById('staffRole').value;
  
  if (!id || !name) {
    showNotification('âš ï¸ è«‹å¡«å¯«å“¡å·¥ç·¨è™Ÿå’Œå§“åï¼', 'warning');
    return;
  }
  
  // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
  const exists = Object.values(staffData).some(roleStaff => 
    roleStaff.some(staff => staff.id === id)
  );
  
  if (exists) {
    showNotification('âš ï¸ è©²å“¡å·¥ç·¨è™Ÿå·²å­˜åœ¨ï¼', 'warning');
    return;
  }
  
  const originalStaff = [...staffData[role]]; // å‚™ä»½åŸå§‹è³‡æ–™
  staffData[role].push({id, name});
  
  const success = await saveData('saveStaff');

  if (success) {
      document.getElementById('staffId').value = '';
      document.getElementById('staffName').value = '';
      updateStaffLists();
      updateStaffSelects();
  } else {
      // å„²å­˜å¤±æ•—ï¼Œå¾©åŸå‰ç«¯è³‡æ–™
      staffData[role] = originalStaff;
  }
}

function removeStaff(role, id) {
  showConfirmDialog('âš ï¸ ç¢ºå®šè¦ç§»é™¤é€™ä½äººå“¡å—ï¼Ÿ', async () => {
    const originalStaff = [...staffData[role]]; // å‚™ä»½åŸå§‹è³‡æ–™
    
    // å¾å‰ç«¯è³‡æ–™ç§»é™¤
    staffData[role] = staffData[role].filter(staff => staff.id !== id);
    
    const success = await saveData('saveStaff');

    if (success) {
        updateStaffLists();
        updateStaffSelects();
    } else {
        // å„²å­˜å¤±æ•—ï¼Œå¾©åŸå‰ç«¯è³‡æ–™
        staffData[role] = originalStaff;
        updateStaffLists();
        updateStaffSelects();
        showNotification('âŒ ç§»é™¤å¤±æ•—ï¼šè³‡æ–™æœªå„²å­˜åˆ°å¾Œç«¯ï¼', 'error');
    }
  });
}

// Excelä¸‹è¼‰åŠŸèƒ½ (ä¸éœ€è¦ä¿®æ”¹ï¼Œå› ç‚ºå®ƒåªè®€å– filteredHistory å’Œ staffData)
function downloadHistoryExcel() {
  if (filteredHistory.length === 0) {
    showNotification('âš ï¸ æ²’æœ‰è³‡æ–™å¯ä»¥ä¸‹è¼‰ï¼è«‹å…ˆæœå°‹æˆ–ç¢ºèªæœ‰æ­·å²ç´€éŒ„ã€‚', 'warning');
    return;
  }
  
  // æº–å‚™Excelè³‡æ–™
  const excelData = [];
  
  // å–å¾—æœå°‹æ¢ä»¶
  const year = document.getElementById('searchYear').value;
  const month = document.getElementById('searchMonth').value;
  const keyword = document.getElementById('searchKeyword').value.trim();
  
  // å»ºç«‹æª”æ¡ˆåç¨±
  let fileName = 'æ–°èæ­·å²ç´€éŒ„';
  const currentDate = new Date().toISOString().split('T')[0];
  
  if (year || month || keyword) {
    fileName += '_ç¯©é¸çµæœ';
    if (year) fileName += `_${year}å¹´`;
    if (month) fileName += `_${month}æœˆ`;
    if (keyword) fileName += `_${keyword}`;
  }
  fileName += `_${currentDate}.xlsx`;
  
  // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
  const sortedData = [...filteredHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // è½‰æ›è³‡æ–™æ ¼å¼
  sortedData.forEach((news, index) => {
    const newsDate = new Date(news.date);
    const editor = staffData.editor.find(s => s.id === news.editor);
    const video = staffData.video.find(s => s.id === news.video);
    const graphic = staffData.graphic.find(s => s.id === news.graphic);
    
    excelData.push({
      'åºè™Ÿ': index + 1,
      'ç™¼å¸ƒæ—¥æœŸ': news.date,
      'å¹´ä»½': newsDate.getFullYear(),
      'æœˆä»½': newsDate.getMonth() + 1,
      'æ˜ŸæœŸ': ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][newsDate.getDay()],
      'æ–°èæ¨™é¡Œ': news.title,
      'é‡é»æ–°è': news.accent ? 'æ˜¯' : 'å¦',
      'ç·¨è¼¯äººå“¡ç·¨è™Ÿ': news.editor,
      'ç·¨è¼¯äººå“¡å§“å': editor ? editor.name : 'å·²é›¢è·',
      'å½±ç‰‡äººå“¡ç·¨è™Ÿ': news.video,
      'å½±ç‰‡äººå“¡å§“å': video ? video.name : 'å·²é›¢è·',
      'å¹³é¢äººå“¡ç·¨è™Ÿ': news.graphic,
      'å¹³é¢äººå“¡å§“å': graphic ? graphic.name : 'å·²é›¢è·',
      'æ­¸æª”æ—¥æœŸ': news.archivedDate || 'æ‰‹å‹•æ­¸æª”',
      'æ¨™é¡Œå­—æ•¸': news.title.length
    });
  });
  
  // å»ºç«‹å·¥ä½œç°¿
  const wb = XLSX.utils.book_new();
  
  // å»ºç«‹å·¥ä½œè¡¨
  const ws = XLSX.utils.json_to_sheet(excelData);
  
  // è¨­å®šæ¬„ä½å¯¬åº¦
  const colWidths = [
    { wch: 6 },   // åºè™Ÿ
    { wch: 12 },  // ç™¼å¸ƒæ—¥æœŸ
    { wch: 8 },   // å¹´ä»½
    { wch: 8 },   // æœˆä»½
    { wch: 8 },   // æ˜ŸæœŸ
    { wch: 50 },  // æ–°èæ¨™é¡Œ
    { wch: 10 },  // é‡é»æ–°è
    { wch: 12 },  // ç·¨è¼¯äººå“¡ç·¨è™Ÿ
    { wch: 15 },  // ç·¨è¼¯äººå“¡å§“å
    { wch: 12 },  // å½±ç‰‡äººå“¡ç·¨è™Ÿ
    { wch: 15 },  // å½±ç‰‡äººå“¡å§“å
    { wch: 12 },  // å¹³é¢äººå“¡ç·¨è™Ÿ
    { wch: 15 },  // å¹³é¢äººå“¡å§“å
    { wch: 12 },  // æ­¸æª”æ—¥æœŸ
    { wch: 10 }   // æ¨™é¡Œå­—æ•¸
  ];
  ws['!cols'] = colWidths;
  
  // åŠ å…¥å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
  XLSX.utils.book_append_sheet(wb, ws, 'æ–°èæ­·å²ç´€éŒ„');
  
  // å¦‚æœæœ‰æœå°‹æ¢ä»¶ï¼Œå»ºç«‹æ‘˜è¦å·¥ä½œè¡¨
  if (year || month || keyword) {
    const summaryData = [];
    
    // æœå°‹æ¢ä»¶æ‘˜è¦
    summaryData.push({
      'é …ç›®': 'æœå°‹æ¢ä»¶',
      'å…§å®¹': ''
    });
    
    if (year) {
      summaryData.push({
        'é …ç›®': 'å¹´ä»½',
        'å…§å®¹': `${year}å¹´`
      });
    }
    
    if (month) {
      summaryData.push({
        'é …ç›®': 'æœˆä»½',
        'å…§å®¹': `${month}æœˆ`
      });
    }
    
    if (keyword) {
      summaryData.push({
        'é …ç›®': 'é—œéµå­—',
        'å…§å®¹': keyword
      });
    }
    
    summaryData.push({
      'é …ç›®': 'æœå°‹çµæœ',
      'å…§å®¹': `å…± ${filteredHistory.length} ç­†æ–°è`
    });
    
    summaryData.push({
      'é …ç›®': 'ä¸‹è¼‰æ™‚é–“',
      'å…§å®¹': new Date().toLocaleString('zh-TW')
    });
    
    // çµ±è¨ˆè³‡æ–™
    summaryData.push({
      'é …ç›®': '',
      'å…§å®¹': ''
    });
    
    summaryData.push({
      'é …ç›®': 'çµ±è¨ˆè³‡æ–™',
      'å…§å®¹': ''
    });
    
    // é‡é»æ–°èçµ±è¨ˆ
    const accentCount = sortedData.filter(news => news.accent).length;
    summaryData.push({
      'é …ç›®': 'é‡é»æ–°èæ•¸é‡',
      'å…§å®¹': `${accentCount} ç­†`
    });
    
    // äººå“¡çµ±è¨ˆ
    const editorStats = {};
    const videoStats = {};
    const graphicStats = {};
    
    sortedData.forEach(news => {
      const editor = staffData.editor.find(s => s.id === news.editor);
      const video = staffData.video.find(s => s.id === news.video);
      const graphic = staffData.graphic.find(s => s.id === news.graphic);
      
      const editorName = editor ? editor.name : 'å·²é›¢è·';
      const videoName = video ? video.name : 'å·²é›¢è·';
      const graphicName = graphic ? graphic.name : 'å·²é›¢è·';
      
      editorStats[editorName] = (editorStats[editorName] || 0) + 1;
      videoStats[videoName] = (videoStats[videoName] || 0) + 1;
      graphicStats[graphicName] = (graphicStats[graphicName] || 0) + 1;
    });
    
    // ç·¨è¼¯äººå“¡çµ±è¨ˆ
    summaryData.push({
      'é …ç›®': '',
      'å…§å®¹': ''
    });
    
    summaryData.push({
      'é …ç›®': 'ç·¨è¼¯äººå“¡çµ±è¨ˆ',
      'å…§å®¹': ''
    });
    
    Object.entries(editorStats).forEach(([name, count]) => {
      summaryData.push({
        'é …ç›®': name,
        'å…§å®¹': `${count} ç¯‡`
      });
    });
    
    // å½±ç‰‡äººå“¡çµ±è¨ˆ
    summaryData.push({
      'é …ç›®': '',
      'å…§å®¹': ''
    });
    
    summaryData.push({
      'é …ç›®': 'å½±ç‰‡äººå“¡çµ±è¨ˆ',
      'å…§å®¹': ''
    });
    
    Object.entries(videoStats).forEach(([name, count]) => {
      summaryData.push({
        'é …ç›®': name,
        'å…§å®¹': `${count} ç¯‡`
      });
    });
    
    // å¹³é¢äººå“¡çµ±è¨ˆ
    summaryData.push({
      'é …ç›®': '',
      'å…§å®¹': ''
    });
    
    summaryData.push({
      'é …ç›®': 'å¹³é¢äººå“¡çµ±è¨ˆ',
      'å…§å®¹': ''
    });
    
    Object.entries(graphicStats).forEach(([name, count]) => {
      summaryData.push({
        'é …ç›®': name,
        'å…§å®¹': `${count} ç¯‡`
      });
    });
    
    // å»ºç«‹æ‘˜è¦å·¥ä½œè¡¨
    const summaryWs = XLSX.utils.json_to_sheet(summaryData);
    summaryWs['!cols'] = [{ wch: 20 }, { wch: 30 }];
    XLSX.utils.book_append_sheet(wb, summaryWs, 'æœå°‹æ‘˜è¦');
  }
  
  // ä¸‹è¼‰æª”æ¡ˆ
  try {
    XLSX.writeFile(wb, fileName);
    showNotification(`âœ… Excelæª”æ¡ˆä¸‹è¼‰æˆåŠŸï¼\næª”æ¡ˆåç¨±ï¼š${fileName}\nå…± ${filteredHistory.length} ç­†è³‡æ–™`, 'success');
  } catch (error) {
    showNotification('âŒ ä¸‹è¼‰å¤±æ•—ï¼è«‹æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´æª”æ¡ˆä¸‹è¼‰åŠŸèƒ½ã€‚', 'error');
    console.error('Excelä¸‹è¼‰éŒ¯èª¤:', error);
  }
}

// ExcelåŒ¯å…¥åŠŸèƒ½
async function importExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    const originalStaffData = { // å‚™ä»½åŸå§‹è³‡æ–™
        editor: [...staffData.editor], 
        video: [...staffData.video], 
        graphic: [...staffData.graphic]
    }; 
    
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(worksheet);
      
      let imported = 0;
      let errors = [];
      
      jsonData.forEach((row, index) => {
        const id = String(row['å“¡å·¥ç·¨è™Ÿ'] || row['ç·¨è™Ÿ'] || '').trim();
        const name = String(row['å§“å'] || row['åå­—'] || '').trim();
        const roleText = String(row['è·ä½'] || row['è§’è‰²'] || '').trim().toLowerCase();
        
        if (!id || !name) {
          errors.push(`ç¬¬${index + 2}è¡Œï¼šç¼ºå°‘å“¡å·¥ç·¨è™Ÿæˆ–å§“å`);
          return;
        }
        
        let targetRole = '';
        if (roleText.includes('ç·¨è¼¯') || roleText.includes('editor')) targetRole = 'editor';
        else if (roleText.includes('å½±ç‰‡') || roleText.includes('video')) targetRole = 'video';
        else if (roleText.includes('å¹³é¢') || roleText.includes('graphic')) targetRole = 'graphic';
        else {
          errors.push(`ç¬¬${index + 2}è¡Œï¼šç„¡æ³•è­˜åˆ¥è·ä½ã€Œ${roleText}ã€`);
          return;
        }
        
        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const exists = Object.values(staffData).some(roleStaff => 
          roleStaff.some(staff => staff.id === id)
        );
        
        if (!exists) {
          staffData[targetRole].push({id, name});
          imported++;
        }
      });
      
      // å‘¼å« API å„²å­˜
      const success = await saveData('saveStaff');

      if (success) {
          let message = `âœ… æˆåŠŸåŒ¯å…¥ ${imported} ç­†äººå“¡è³‡æ–™ï¼`;
          if (errors.length > 0) {
            message += `\n\nâš ï¸ ç™¼ç¾ ${errors.length} å€‹å•é¡Œï¼š\n${errors.slice(0, 5).join('\n')}`;
            if (errors.length > 5) {
              message += `\n... é‚„æœ‰ ${errors.length - 5} å€‹å•é¡Œ`;
            }
          }
          showNotification(message, 'success');
          updateStaffLists();
          updateStaffSelects();
      } else {
          // å„²å­˜å¤±æ•—ï¼Œå¾©åŸå‰ç«¯è³‡æ–™
          staffData = originalStaffData;
          updateStaffLists();
          updateStaffSelects();
      }
      
    } catch (error) {
      showNotification('âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼è«‹ç¢ºèªExcelæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚\n\nå»ºè­°æ ¼å¼ï¼š\n- å“¡å·¥ç·¨è™Ÿ | å§“å | è·ä½\n- è·ä½è«‹å¡«å¯«ï¼šç·¨è¼¯ã€å½±ç‰‡ã€å¹³é¢', 'error');
    }
  };
  reader.readAsArrayBuffer(file);
  
  // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
  event.target.value = '';
}

// æ­·å²ç´€éŒ„åŠŸèƒ½ (åªè®€å–è³‡æ–™ï¼Œä¸éœ€è¦ä¿®æ”¹)
function showHistoryModal() {
  updateYearOptions();
  clearSearch();
  document.getElementById('historyModal').classList.add('show');
}

function updateYearOptions() {
  const yearSelect = document.getElementById('searchYear');
  const currentYear = new Date().getFullYear();
  const years = new Set();
  
  // æ”¶é›†æ‰€æœ‰å¹´ä»½
  historyData.forEach(news => {
    const year = new Date(news.date).getFullYear();
    years.add(year);
  });
  
  // å¾2025å¹´é–‹å§‹ï¼Œæ¯å¹´è‡ªå‹•å¢åŠ åˆ°ç•¶å‰å¹´ä»½+1
  const startYear = 2025;
  const endYear = Math.max(currentYear + 1, startYear);
  for (let i = startYear; i <= endYear; i++) {
    years.add(i);
  }
  
  yearSelect.innerHTML = '<option value="">é¸æ“‡å¹´ä»½</option>';
  [...years].sort((a, b) => b - a).forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = `${year}å¹´`;
    yearSelect.appendChild(option);
  });
}

function searchHistory() {
  const year = document.getElementById('searchYear').value;
  const month = document.getElementById('searchMonth').value;
  const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
  
  filteredHistory = historyData.filter(news => {
    const newsDate = new Date(news.date);
    
    // å¹´ä»½ç¯©é¸
    if (year && newsDate.getFullYear() !== parseInt(year)) {
      return false;
    }
    
    // æœˆä»½ç¯©é¸
    if (month && (newsDate.getMonth() + 1) !== parseInt(month)) {
      return false;
    }
    
    // é—œéµå­—ç¯©é¸
    if (keyword && !news.title.toLowerCase().includes(keyword)) {
      return false;
    }
    
    return true;
  });
  
  displayHistoryResults();
  
  // é¡¯ç¤ºæœå°‹çµæœçµ±è¨ˆ
  const resultsSpan = document.getElementById('searchResults');
  if (year || month || keyword) {
    resultsSpan.textContent = `æ‰¾åˆ° ${filteredHistory.length} ç­†ç¬¦åˆæ¢ä»¶çš„æ–°è`;
  } else {
    resultsSpan.textContent = '';
  }
}

function clearSearch() {
  document.getElementById('searchYear').value = '';
  document.getElementById('searchMonth').value = '';
  document.getElementById('searchKeyword').value = '';
  document.getElementById('searchResults').textContent = '';
  
  filteredHistory = [...historyData];
  displayHistoryResults();
}

function displayHistoryResults() {
  const container = document.getElementById('historyList');
  const countSpan = document.getElementById('historyCount');
  
  container.innerHTML = '';
  countSpan.textContent = filteredHistory.length;
  
  if (filteredHistory.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:var(--muted); margin:20px 0">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ­·å²æ–°è</p>';
    return;
  }
  
  // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
  const sortedHistory = [...filteredHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
  
  sortedHistory.forEach(news => {
    const newsDate = new Date(news.date);
    const editor = staffData.editor.find(s => s.id === news.editor);
    const video = staffData.video.find(s => s.id === news.video);
    const graphic = staffData.graphic.find(s => s.id === news.graphic);
    
    const historyItem = document.createElement('div');
    
    // æ­·å²ç´€éŒ„ä¸­çš„é‡é»æ–°èé¡¯ç¤ºç‚ºç´«è‰²
    const bgColor = news.accent ? 'var(--soft-purple)' : '#fff';
    const borderColor = news.accent ? 'var(--soft-purple-line)' : 'var(--line)';
    const titleColor = news.accent ? 'var(--purple)' : 'var(--ink)';
    const starIcon = news.accent ? 'ğŸŸ£' : '';
    
    historyItem.style.cssText = `
      border: 1px solid ${borderColor}; border-radius: 8px; padding: 12px; margin: 8px 0;
      background: ${bgColor};
    `;
    
    historyItem.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px">
        <div style="flex: 1">
          <div style="font-size: 14px; color: var(--muted); margin-bottom: 4px">
            ğŸ“… ç™¼å¸ƒæ—¥æœŸï¼š${news.date} ${starIcon}
            ${news.archivedDate ? `<span style="margin-left: 12px">ğŸ—‚ï¸ æ­¸æª”ï¼š${news.archivedDate}</span>` : ''}
          </div>
          <div style="font-weight: 600; margin-bottom: 8px; color: ${titleColor}">
            ${news.title}
          </div>
          <div style="font-size: 12px; color: var(--muted)">
            ç·¨è¼¯ï¼š${news.editor}ï¼ˆ${editor ? editor.name : 'å·²é›¢è·'}ï¼‰ | 
            å½±ç‰‡ï¼š${news.video}ï¼ˆ${video ? video.name : 'å·²é›¢è·'}ï¼‰ | 
            å¹³é¢ï¼š${news.graphic}ï¼ˆ${graphic ? graphic.name : 'å·²é›¢è·'}ï¼‰
          </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 4px">
          <button onclick="restoreNews('${news.id}', '${news.date}')" style="
            background: var(--green); color: white; border: none; padding: 4px 8px;
            border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap;
          ">å¾©åŸ</button>
          <button onclick="permanentDeleteNews('${news.id}', '${news.date}')" style="
            background: var(--accent); color: white; border: none; padding: 4px 8px;
            border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap;
          ">æ°¸ä¹…åˆªé™¤</button>
        </div>
      </div>
    `;
    
    container.appendChild(historyItem);
  });
}

function restoreNews(id, date) {
  if (!isAdminMode) {
    showNotification('âŒ è«‹å…ˆç™»å…¥ç®¡ç†å¾Œå°ï¼', 'error');
    return;
  }
  
  showConfirmDialog('âš ï¸ ç¢ºå®šè¦å¾©åŸé€™å‰‡æ–°èåˆ°ç•¶å‰æ–°èåˆ—è¡¨å—ï¼Ÿ', async () => {
    const historyNews = historyData.find(h => h.id == id && h.date === date);
    
    if (historyNews) {
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼ç•¶å‰æ–°èä¸­
      const exists = newsData.some(n => n.id == historyNews.id && n.date === historyNews.date);
      if (exists) {
        showNotification('âš ï¸ è©²æ–°èå·²å­˜åœ¨æ–¼ç•¶å‰æ–°èåˆ—è¡¨ä¸­ï¼', 'warning');
        return;
      }
      
      const originalNewsData = [...newsData]; // å‚™ä»½åŸå§‹è³‡æ–™
      const originalHistoryData = [...historyData];

      // å¾©åŸåˆ°ç•¶å‰æ–°èï¼ˆç§»é™¤æ­¸æª”æ—¥æœŸï¼‰
      const { archivedDate, ...restoredNews } = historyNews;
      newsData.push(restoredNews);
      
      // å¾æ­·å²ç´€éŒ„ä¸­ç§»é™¤
      historyData = historyData.filter(h => !(h.id == id && h.date === date));
      filteredHistory = filteredHistory.filter(h => !(h.id == id && h.date === date));
      
      const success = await saveData('restoreNews');
      
      if (success) {
        renderNews(); // æ›´æ–°ä¸»é é¢
        updateAdminNewsList(); // æ›´æ–°ç®¡ç†å¾Œå°åˆ—è¡¨
        closeModal('historyModal');
        // å»¶é²é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼Œç¢ºä¿è¦–çª—å·²é—œé–‰
        setTimeout(() => {
          showNotification('âœ… æ–°èå·²å¾©åŸåˆ°ä¸»é é¢ï¼', 'success');
        }, 100);
      } else {
         // å„²å­˜å¤±æ•—ï¼Œå¾©åŸå‰ç«¯è³‡æ–™
        newsData = originalNewsData;
        historyData = originalHistoryData;
        filteredHistory = originalHistoryData.filter(h => !(h.id == id && h.date === date)); // ç°¡å–®å¾©åŸ
        displayHistoryResults();
        showNotification('âŒ å¾©åŸå¤±æ•—ï¼šè³‡æ–™æœªå„²å­˜åˆ°å¾Œç«¯ï¼', 'error');
      }
    } else {
      showNotification('âŒ å¾©åŸå¤±æ•—ï¼šæ‰¾ä¸åˆ°æŒ‡å®šçš„æ–°èï¼', 'error');
    }
  });
}

function permanentDeleteNews(id, date) {
  if (!isAdminMode) {
    showNotification('âŒ è«‹å…ˆç™»å…¥ç®¡ç†å¾Œå°ï¼', 'error');
    return;
  }
  
  showConfirmDialog('âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å‰‡æ–°èå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼', async () => {
    const originalHistoryData = [...historyData]; // å‚™ä»½åŸå§‹è³‡æ–™
    
    // å¾æ­·å²ç´€éŒ„ä¸­å®Œå…¨ç§»é™¤
    historyData = historyData.filter(h => !(h.id == id && h.date === date));
    filteredHistory = filteredHistory.filter(h => !(h.id == id && h.date === date));
    
    const success = await saveData('deleteHistory');

    if (success) {
      displayHistoryResults(); // é‡æ–°é¡¯ç¤ºçµæœ
    } else {
      // å„²å­˜å¤±æ•—ï¼Œå¾©åŸå‰ç«¯è³‡æ–™
      historyData = originalHistoryData;
      filteredHistory = originalHistoryData.filter(h => !(h.id == id && h.date === date)); // ç°¡å–®å¾©åŸ
      displayHistoryResults();
      showNotification('âŒ åˆªé™¤å¤±æ•—ï¼šè³‡æ–™æœªå„²å­˜åˆ°å¾Œç«¯ï¼', 'error');
    }
  });
}

// ------------------------------------------------------------------
// ç§»é™¤èˆŠçš„ localStorage ç›¸é—œå‡½æ•¸
// ------------------------------------------------------------------
// èˆŠçš„ saveData() å’Œ loadData() å‡½æ•¸å·²è¢«æ–°çš„ API å‡½æ•¸å–ä»£å’Œç§»é™¤ã€‚

// é€šç”¨åŠŸèƒ½
function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

// é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('show');
  }
});

// éµç›¤å¿«æ·éµ
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modals = document.querySelectorAll('.modal.show');
    modals.forEach(modal => modal.classList.remove('show'));
  }
});

// è‡ªå®šç¾©é€šçŸ¥ç³»çµ±
function showNotification(message, type = 'info') {
  // ç§»é™¤ç¾æœ‰é€šçŸ¥
  const existingNotification = document.querySelector('.notification');
  if (existingNotification) {
    existingNotification.remove();
  }
  
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.textContent = message;
  
  const colors = {
    success: '#059669',
    error: '#DC2626',
    warning: '#D97706',
    info: '#2563EB'
  };
  
  notification.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: ${colors[type]};
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    max-width: 400px;
    white-space: pre-line;
    animation: slideIn 0.3s ease-out;
  `;
  
  // æ·»åŠ å‹•ç•«æ¨£å¼
  if (!document.querySelector('#notification-styles')) {
    const style = document.createElement('style');
    style.id = 'notification-styles';
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(notification);
  
  // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 300);
  }, 3000);
}

// è‡ªå®šç¾©ç¢ºèªå°è©±æ¡†
function showConfirmDialog(message, onConfirm) {
  // ç§»é™¤ç¾æœ‰å°è©±æ¡†
  const existingDialog = document.querySelector('.confirm-dialog');
  if (existingDialog) {
    existingDialog.remove();
  }
  
  const overlay = document.createElement('div');
  overlay.className = 'confirm-dialog';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
  `;
  
  const dialog = document.createElement('div');
  dialog.style.cssText = `
    background: white;
    padding: 32px;
    border-radius: 16px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  `;
  
  dialog.innerHTML = `
    <p style="margin: 0 0 24px; font-size: 16px; line-height: 1.5; color: var(--ink);">${message}</p>
    <div>
      <button class="btn danger" onclick="confirmAction()">ç¢ºå®š</button>
      <button class="btn secondary" onclick="cancelAction()">å–æ¶ˆ</button>
    </div>
  `;
  
  overlay.appendChild(dialog);
  document.body.appendChild(overlay);
  
  // å…¨åŸŸå‡½æ•¸è™•ç†ç¢ºèªå’Œå–æ¶ˆ
  window.confirmAction = function() {
    overlay.remove();
    onConfirm();
    delete window.confirmAction;
    delete window.cancelAction;
  };
  
  window.cancelAction = function() {
    overlay.remove();
    delete window.confirmAction;
    delete window.cancelAction;
  };
  
  // é»æ“Šå¤–éƒ¨é—œé–‰
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) {
      window.cancelAction();
    }
  });
}
</script>
</body>
</html>
